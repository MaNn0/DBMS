#!/bin/bash

# Check if table name is provided
if [ -z "$1" ]; then
    echo "Error: Table name not provided."
    exit 1
fi

tableName="$1"
metadataFile=".$tableName""_metadata"

# Check if the table's metadata file exists
if [[ ! -f "$metadataFile" ]]; then
    echo "Error: Table '$tableName' does not exist."
    exit 1
fi

# Read the table structure (metadata) into an array
columns=()
columnNames=()
for line in $(cat "$metadataFile"); do
    IFS=':' read -r colName colType colKey <<< "$line"
    columns+=("$line")
    columnNames+=("$colName")
done

# Show all columns with assigned numbers
echo "Available columns:"
for i in "${!columnNames[@]}"; do
    echo "$((i+1)): ${columnNames[$i]}"
done

# Prompt the user to select a column to delete
read -p "Enter the column number to delete from or 0 to delete all column values: " colChoice

# Function to delete values from the selected column
delete_column_values() {
    local columnIndex=$1
    echo "Deleting values from column '${columnNames[$columnIndex]}':"

    # Show the available values in the selected column
    echo "Available values in column '${columnNames[$columnIndex]}':"
    awk -F":" -v colIndex=$((columnIndex+1)) '{ print $colIndex }' "$tableName" | sort | uniq

    # Ask for value to delete from selected column or delete all values
    read -p "Enter value to delete or press enter to delete all values: " valueToDelete

    # If value is provided, check if it's valid
    if [ -n "$valueToDelete" ]; then
        # Check if the value exists in the selected column
        if ! awk -F":" -v colIndex=$((columnIndex+1)) -v value="$valueToDelete" '{ if($colIndex == value) print $0 }' "$tableName" | grep -q .; then
            echo "Error: Value '$valueToDelete' does not exist in column '${columnNames[$columnIndex]}'."
            exit 1
        fi

        echo "Deleting rows where column '${columnNames[$columnIndex]}' contains '$valueToDelete'."
        # Delete rows where the selected column contains the value
        awk -F":" -v colIndex=$((columnIndex+1)) -v value="$valueToDelete" '{ if($colIndex != value) print $0 }' OFS=":" "$tableName" > temp.txt
        mv temp.txt "$tableName"
    else
        # If no value is provided, delete all rows in the selected column
        echo "Deleting all values in column '${columnNames[$columnIndex]}'."
        # Set the value of the specified column to empty for all rows
        awk -F":" -v colIndex=$((columnIndex+1)) '{ $colIndex=""; print $0 }' OFS=":" "$tableName" > temp.txt
        mv temp.txt "$tableName"
    fi

    echo "Deletion complete."
}

# Delete all values from all columns if 0 is selected
if [ "$colChoice" -eq 0 ]; then
    echo "Deleting all column values..."
    > "$tableName"  # Clear the table (delete all rows)
    echo "All values deleted."
else
    # Validate if the choice is valid
    if [[ "$colChoice" -ge 1 && "$colChoice" -le ${#columns[@]} ]]; then
        # Delete values from the selected column
        delete_column_values $((colChoice - 1))
    else
        echo "Error: Invalid column number selected."
        exit 1
    fi
fi
